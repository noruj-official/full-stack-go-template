services:
  # PostgreSQL Database
  postgres:
    image: postgres:17-alpine
    container_name: go_starter_db
    restart: unless-stopped
    environment:
      POSTGRES_USER: "${POSTGRES_USER:-postgres}"
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD:-postgres}"
      POSTGRES_DB: "${POSTGRES_DB:-app_db}"
    ports:
      - "${POSTGRES_BIND:-127.0.0.1}:${POSTGRES_PUBLIC_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d app_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Go Application
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: go_starter_app
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      # Server
      SERVER_HOST: "${SERVER_HOST:-0.0.0.0}"
      SERVER_PORT: "${SERVER_PORT:-3000}"
      # Database - connects to postgres container
      POSTGRES_HOST: postgres
      POSTGRES_PORT: "${POSTGRES_PORT:-5432}"
      POSTGRES_USER: "${POSTGRES_USER:-postgres}"
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD:-postgres}"
      POSTGRES_DB: "${POSTGRES_DB:-app_db}"
      POSTGRES_SSLMODE: "${POSTGRES_SSLMODE:-disable}"
      # App
      APP_ENV: "${APP_ENV:-production}"
      APP_NAME: "${APP_NAME:-Full Stack Go Template}"
      APP_URL: "${APP_URL:-http://localhost:3000}"
      APP_LOGO: "${APP_LOGO:-/static/img/logo.svg}"
      # Auth - CHANGE THIS IN PRODUCTION!
      AUTH_SECRET: "${AUTH_SECRET:-change-me-in-production}"
      # Email (optional)
      RESEND_API_KEY: "${RESEND_API_KEY:-}"
      RESEND_FROM_EMAIL: "${RESEND_FROM_EMAIL:-onboarding@resend.dev}"
      # Storage
      PROFILE_IMAGE_STORAGE: "${PROFILE_IMAGE_STORAGE:-database}"
      S3_BUCKET: "${S3_BUCKET:-}"
      S3_REGION: "${S3_REGION:-}"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 3s
      start_period: 10s
      retries: 3

volumes:
  postgres_data:
